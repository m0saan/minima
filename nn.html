<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="The nn module, a key part of the minima’s toolkit, is a pretty cool and all-encompassing software.">

<title>minima - nn</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="minima - nn">
<meta property="og:description" content="The nn module, a key part of the minima’s toolkit, is a pretty cool and all-encompassing software.">
<meta property="og:site-name" content="minima">
<meta name="twitter:title" content="minima - nn">
<meta name="twitter:description" content="The nn module, a key part of the minima’s toolkit, is a pretty cool and all-encompassing software.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">minima</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./nn.html">nn</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome to minima</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./autograd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">autograd</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./operators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">operators</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./init.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">init</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nn.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">nn</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optim.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">optim</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ndarray.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ndarray</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ndarray_backend_numpy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ndarray_backend_numpy</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">utility</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#parameter" id="toc-parameter" class="nav-link active" data-scroll-target="#parameter">Parameter</a></li>
  <li><a href="#module" id="toc-module" class="nav-link" data-scroll-target="#module">Module</a></li>
  <li><a href="#sequential" id="toc-sequential" class="nav-link" data-scroll-target="#sequential">Sequential</a></li>
  <li><a href="#linear" id="toc-linear" class="nav-link" data-scroll-target="#linear">Linear</a></li>
  <li><a href="#flatten" id="toc-flatten" class="nav-link" data-scroll-target="#flatten">Flatten</a></li>
  <li><a href="#relu" id="toc-relu" class="nav-link" data-scroll-target="#relu">ReLU</a></li>
  <li><a href="#sigmoid" id="toc-sigmoid" class="nav-link" data-scroll-target="#sigmoid">Sigmoid</a></li>
  <li><a href="#crossentropyloss" id="toc-crossentropyloss" class="nav-link" data-scroll-target="#crossentropyloss">CrossEntropyLoss</a></li>
  <li><a href="#softmax" id="toc-softmax" class="nav-link" data-scroll-target="#softmax">Softmax</a></li>
  <li><a href="#layer-normalization" id="toc-layer-normalization" class="nav-link" data-scroll-target="#layer-normalization">Layer normalization</a>
  <ul class="collapse">
  <li><a href="#layernorm1d" id="toc-layernorm1d" class="nav-link" data-scroll-target="#layernorm1d">LayerNorm1d</a></li>
  </ul></li>
  <li><a href="#batch-norm" id="toc-batch-norm" class="nav-link" data-scroll-target="#batch-norm">Batch Norm</a>
  <ul class="collapse">
  <li><a href="#internal-covariate-shift" id="toc-internal-covariate-shift" class="nav-link" data-scroll-target="#internal-covariate-shift">Internal Covariate Shift</a></li>
  </ul></li>
  <li><a href="#normalization" id="toc-normalization" class="nav-link" data-scroll-target="#normalization">Normalization</a>
  <ul class="collapse">
  <li><a href="#normalizing-outside-gradient-computation-doesnt-work" id="toc-normalizing-outside-gradient-computation-doesnt-work" class="nav-link" data-scroll-target="#normalizing-outside-gradient-computation-doesnt-work">Normalizing outside gradient computation doesn’t work</a></li>
  <li><a href="#batch-normalization" id="toc-batch-normalization" class="nav-link" data-scroll-target="#batch-normalization">Batch Normalization</a></li>
  </ul></li>
  <li><a href="#inference" id="toc-inference" class="nav-link" data-scroll-target="#inference">Inference</a>
  <ul class="collapse">
  <li><a href="#batchnorm1d" id="toc-batchnorm1d" class="nav-link" data-scroll-target="#batchnorm1d">BatchNorm1d</a></li>
  <li><a href="#dropout" id="toc-dropout" class="nav-link" data-scroll-target="#dropout">Dropout</a></li>
  </ul></li>
  <li><a href="#parameters" id="toc-parameters" class="nav-link" data-scroll-target="#parameters">Parameters:</a>
  <ul class="collapse">
  <li><a href="#residual" id="toc-residual" class="nav-link" data-scroll-target="#residual">Residual</a></li>
  </ul></li>
  <li><a href="#parameters-1" id="toc-parameters-1" class="nav-link" data-scroll-target="#parameters-1">Parameters:</a>
  <ul class="collapse">
  <li><a href="#identity" id="toc-identity" class="nav-link" data-scroll-target="#identity">Identity</a></li>
  </ul></li>
  <li><a href="#export" id="toc-export" class="nav-link" data-scroll-target="#export">Export</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/m0saan/minima/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">nn</h1>
</div>

<div>
  <div class="description">
    The nn module, a key part of the minima’s toolkit, is a pretty cool and all-encompassing software.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<hr>
<p><a href="https://github.com/m0saan/minima/blob/main/minima/nn.py#L17" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="parameter" class="level3">
<h3 class="anchored" data-anchor-id="parameter">Parameter</h3>
<blockquote class="blockquote">
<pre><code> Parameter (array, device:Optional[minima.autograd.Device]=None,
            dtype=None, requires_grad=True, **kwargs)</code></pre>
</blockquote>
<p>A kind of Tensor that is to be considered a module parameter.</p>
<p>Parameters are <a href="https://m0saan.github.io/minima/autograd.html#tensor"><code>Tensor</code></a> subclasses, that have a very special property when used with <a href="https://m0saan.github.io/minima/nn.html#module"><code>Module</code></a> s - when they’re assigned as Module attributes they are automatically added to the list of its parameters, and will appear in <code>Module.parameters()</code> iterator. Another difference is that parameters can’t be volatile and that they require gradient by default.</p>
<hr>
<p><a href="https://github.com/m0saan/minima/blob/main/minima/nn.py#L98" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="module" class="level3">
<h3 class="anchored" data-anchor-id="module">Module</h3>
<blockquote class="blockquote">
<pre><code> Module ()</code></pre>
</blockquote>
<p>Base class for all neural network modules in Minima.</p>
<p>Your models should also subclass this class. Subclasses should define a <code>forward</code> method.</p>
<p>Attributes: - <code>training</code> (bool): Module is initialized in training mode by default. Use <code>eval()</code> to switch it to evaluation mode.</p>
<p>Methods: - <code>parameters()</code>: Returns a list of all <a href="https://m0saan.github.io/minima/nn.html#parameter"><code>Parameter</code></a> instances in the module. - <code>_children()</code>: Returns a list of all child <a href="https://m0saan.github.io/minima/nn.html#module"><code>Module</code></a> instances. - <code>eval()</code>: Switches the module and all its children to evaluation mode. - <code>train()</code>: Switches the module and all its children back to training mode. - <code>__call__()</code>: The call method, which simply calls the <code>forward</code> method, must be defined by all subclasses.</p>
<hr>
<p><a href="https://github.com/m0saan/minima/blob/main/minima/nn.py#L243" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="sequential" class="level3">
<h3 class="anchored" data-anchor-id="sequential">Sequential</h3>
<blockquote class="blockquote">
<pre><code> Sequential (*modules)</code></pre>
</blockquote>
<p>A sequential container in Minima.</p>
<p>Modules will be added to it in the order they are passed in the constructor. A <a href="https://m0saan.github.io/minima/nn.html#sequential"><code>Sequential</code></a> module contains a sequence of child modules stored in the order they were added. Each module is applied in order to the input to produce the output.</p>
<p>The <a href="https://m0saan.github.io/minima/nn.html#sequential"><code>Sequential</code></a> class makes it easy to build networks where the output of one layer is the input to the next.</p>
<p>Attributes: - <code>modules</code> (tuple of <a href="https://m0saan.github.io/minima/nn.html#module"><code>Module</code></a>): The sequence of child modules to apply.</p>
<p>Methods: - <code>forward(x: Tensor) -&gt; Tensor</code>: Passes the input through all the child modules in sequential order.</p>
<hr>
<p><a href="https://github.com/m0saan/minima/blob/main/minima/nn.py#L302" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="linear" class="level3">
<h3 class="anchored" data-anchor-id="linear">Linear</h3>
<blockquote class="blockquote">
<pre><code> Linear (in_features, out_features, bias=True, device=None,
         dtype='float32')</code></pre>
</blockquote>
<p>A class representing a fully connected (linear) layer in a neural network. This class inherits from the <a href="https://m0saan.github.io/minima/nn.html#module"><code>Module</code></a> class.</p>
<p>Attributes: in_features (int): The number of input features. out_features (int): The number of output features. device (str): The device to store the Parameters on (defaults to None, which means CPU). dtype (str): The data type of the Parameters (defaults to ‘float32’). weight (Parameter): The weight parameters of the layer. bias (Parameter): The bias parameters of the layer, or None if bias=False.</p>
<p>Methods: forward(X: Tensor) -&gt; Tensor: Compute the forward pass of the layer.</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>in_features</td>
<td></td>
<td></td>
<td>The number of input features.</td>
</tr>
<tr class="even">
<td>out_features</td>
<td></td>
<td></td>
<td>The number of output features.</td>
</tr>
<tr class="odd">
<td>bias</td>
<td>bool</td>
<td>True</td>
<td>Whether or not to include a bias term. Default is True.</td>
</tr>
<tr class="even">
<td>device</td>
<td>NoneType</td>
<td>None</td>
<td>The device to store the Parameters on. Default is None, which means CPU.</td>
</tr>
<tr class="odd">
<td>dtype</td>
<td>str</td>
<td>float32</td>
<td>The data type of the Parameters. Default is ‘float32’.</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> minima.optim <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyModule(Module):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.layer1 <span class="op">=</span> mi.nn.Linear(<span class="dv">10</span>, <span class="dv">20</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.layer2 <span class="op">=</span> mi.nn.Linear(<span class="dv">20</span>, <span class="dv">10</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.layer1(x)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.layer2(x)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>my_module <span class="op">=</span> MyModule()</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>my_module</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>MyModule()</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>my_module.parameters()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>tt <span class="op">=</span> mi.nn.Linear(in_features<span class="op">=</span><span class="dv">10</span>, out_features<span class="op">=</span><span class="dv">5</span>, bias<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">isinstance</span>(tt, mi.nn.Module)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>True</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/m0saan/minima/blob/main/minima/nn.py#L371" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="flatten" class="level3">
<h3 class="anchored" data-anchor-id="flatten">Flatten</h3>
<blockquote class="blockquote">
<pre><code> Flatten ()</code></pre>
</blockquote>
<p>A <a href="https://m0saan.github.io/minima/nn.html#flatten"><code>Flatten</code></a> module in Minima.</p>
<p>This module flattens an input tensor into a 2D matrix, typically for transitioning from convolutional layers to linear layers within a neural network model.</p>
<p>Methods: - <code>forward(X: Tensor) -&gt; Tensor</code>: Flattens the input tensor.</p>
<hr>
<p><a href="https://github.com/m0saan/minima/blob/main/minima/operators.py#L501" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="relu" class="level3">
<h3 class="anchored" data-anchor-id="relu">ReLU</h3>
<blockquote class="blockquote">
<pre><code> ReLU ()</code></pre>
</blockquote>
<p>Base class for all neural network modules in Minima.</p>
<p>Your models should also subclass this class. Subclasses should define a <code>forward</code> method.</p>
<p>Attributes: - <code>training</code> (bool): Module is initialized in training mode by default. Use <code>eval()</code> to switch it to evaluation mode.</p>
<p>Methods: - <code>parameters()</code>: Returns a list of all <a href="https://m0saan.github.io/minima/nn.html#parameter"><code>Parameter</code></a> instances in the module. - <code>_children()</code>: Returns a list of all child <a href="https://m0saan.github.io/minima/nn.html#module"><code>Module</code></a> instances. - <code>eval()</code>: Switches the module and all its children to evaluation mode. - <code>train()</code>: Switches the module and all its children back to training mode. - <code>__call__()</code>: The call method, which simply calls the <code>forward</code> method, must be defined by all subclasses.</p>
<hr>
<p><a href="https://github.com/m0saan/minima/blob/main/minima/nn.py#L402" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="sigmoid" class="level3">
<h3 class="anchored" data-anchor-id="sigmoid">Sigmoid</h3>
<blockquote class="blockquote">
<pre><code> Sigmoid ()</code></pre>
</blockquote>
<p>Base class for all neural network modules in Minima.</p>
<p>Your models should also subclass this class. Subclasses should define a <code>forward</code> method.</p>
<p>Attributes: - <code>training</code> (bool): Module is initialized in training mode by default. Use <code>eval()</code> to switch it to evaluation mode.</p>
<p>Methods: - <code>parameters()</code>: Returns a list of all <a href="https://m0saan.github.io/minima/nn.html#parameter"><code>Parameter</code></a> instances in the module. - <code>_children()</code>: Returns a list of all child <a href="https://m0saan.github.io/minima/nn.html#module"><code>Module</code></a> instances. - <code>eval()</code>: Switches the module and all its children to evaluation mode. - <code>train()</code>: Switches the module and all its children back to training mode. - <code>__call__()</code>: The call method, which simply calls the <code>forward</code> method, must be defined by all subclasses.</p>
<p>The implementation you’ve shared is a numerically stable version of the Cross Entropy Loss formula, which is generally defined for a single sample as:</p>
<p><span class="math display">\[
H(p, q) = - \sum_{i} p_i \log(q_i)
\]</span></p>
<p>where: - <span class="math inline">\(p\)</span> is the true distribution (in classification, typically a one-hot encoded vector), - <span class="math inline">\(q\)</span> is the predicted distribution (output of the softmax function on the logits from the model).</p>
<p>However, directly implementing this formula can lead to numerical instability because of the log operation. The given implementation overcomes this by using the Log-Sum-Exp trick to prevent underflow or overflow. <span class="math display">\[ CE = -\sum_{i=1}^{C} y_i \log(\hat{y_i}) \]</span></p>
<p>where <span class="math inline">\(y\)</span> is the ground truth label and <span class="math inline">\(\hat{y}\)</span> is the predicted probability, and <span class="math inline">\(C\)</span> is the number of classes. In the case of one-hot encoding, only the term corresponding to the true class contributes to the sum. So, we can simplify it to:</p>
<p><span class="math display">\[
CE = -\log(\hat{y_c})
\]</span></p>
<p>where <span class="math inline">\(c\)</span> is the correct class.</p>
<p>The predicted probabilities <span class="math inline">\(\hat{y}\)</span> are obtained by applying the softmax function to the logits <span class="math inline">\(z\)</span>:</p>
<p><span class="math display">\[
\hat{y_i} = \frac{e^{z_i}}{\sum_{j=1}^{C} e^{z_j}}
\]</span></p>
<p>Substituting <span class="math inline">\(\hat{y_c}\)</span> in the Cross-Entropy Loss, we have:</p>
<p><span class="math display">\[
CE = -\log\left(\frac{e^{z_c}}{\sum_{j=1}^{C} e^{z_j}}\right)
\]</span></p>
<p>Applying the logarithm property <span class="math inline">\(\log(a/b) = \log(a) - \log(b)\)</span>, we get:</p>
<p><span class="math display">\[
CE = -z_c + \log\left(\sum_{j=1}^{C} e^{z_j}\right)
\]</span></p>
<p>First, <code>log_sum_exp_logits = operators.logsumexp(logits, axes=(1, )).sum()</code> computes the term <span class="math inline">\(\log\left(\sum_{j=1}^{C} e^{z_j}\right)\)</span>. The function <a href="https://m0saan.github.io/minima/operators.html#logsumexp"><code>logsumexp</code></a> computes the logarithm of the sum of exponentials in a numerically stable way, and then these values are summed over all samples.</p>
<p>Second, <code>true_class_logits_sum = (logits * init.one_hot(logits.shape[1], y)).sum()</code> computes the <span class="math inline">\(-z_c\)</span> term for each sample. The function <code>init.one_hot(logits.shape[1], y)</code> creates a one-hot encoding of the true labels, and this is then multiplied with the logits to pick out the logits for the correct classes. These values are then summed over all samples.</p>
<p>Finally, <code>(log_sum_exp_logits - true_class_logits_sum) / logits.shape[0]</code> computes the average loss per sample.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>logits <span class="op">=</span> mi.Tensor([[ <span class="fl">0.6734</span>,  <span class="fl">0.2576</span>],</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>        [ <span class="fl">0.4689</span>,  <span class="fl">0.4607</span>],</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        [<span class="op">-</span><span class="fl">2.2457</span>, <span class="op">-</span><span class="fl">0.3727</span>],</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        [ <span class="fl">4.4164</span>, <span class="op">-</span><span class="fl">1.2760</span>],</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        [ <span class="fl">0.9233</span>,  <span class="fl">0.5347</span>],</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        [ <span class="fl">1.0698</span>,  <span class="fl">1.6187</span>]])</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>targ <span class="op">=</span> mi.Tensor([<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>log_sum_exp_logits <span class="op">=</span> operators.logsumexp(logits, axes<span class="op">=</span>(<span class="dv">1</span>, ))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>log_sum_exp_logits</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>minima.Tensor(
[ 1.180104  1.157956 -0.229759  4.419766  1.440906  2.074595])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>log_sum_exp_logits <span class="op">=</span> log_sum_exp_logits.<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>one_hot_y <span class="op">=</span> init.one_hot(logits.shape[<span class="dv">1</span>], targ)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>one_hot_y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>minima.Tensor(
[[1. 0.]
 [0. 1.]
 [1. 0.]
 [0. 1.]
 [0. 1.]
 [1. 0.]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>true_class_logits <span class="op">=</span> (logits <span class="op">*</span> one_hot_y)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>true_class_logits</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>minima.Tensor(
[[ 0.6734  0.    ]
 [ 0.      0.4607]
 [-2.2457 -0.    ]
 [ 0.     -1.276 ]
 [ 0.      0.5347]
 [ 1.0698  0.    ]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>true_class_logits_sum <span class="op">=</span> true_class_logits.<span class="bu">sum</span>()</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>true_class_logits_sum</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>minima.Tensor(
-0.7830999999999999)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> (log_sum_exp_logits <span class="op">-</span> true_class_logits_sum) <span class="op">/</span> targ.shape[<span class="dv">0</span>]</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>minima.Tensor(
1.8044446680186768)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> torch.nn.CrossEntropyLoss()(torch.tensor(logits.numpy()), torch.tensor(targ.numpy()))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(1.8044, dtype=torch.float64)</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/m0saan/minima/blob/main/minima/nn.py#L407" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="crossentropyloss" class="level3">
<h3 class="anchored" data-anchor-id="crossentropyloss">CrossEntropyLoss</h3>
<blockquote class="blockquote">
<pre><code> CrossEntropyLoss ()</code></pre>
</blockquote>
<p>Cross-entropy loss module in Minima.</p>
<p>This module computes the Cross Entropy Loss between the input logits and the target classes. It’s useful in classification tasks where the model outputs probabilities for each class.</p>
<p>Methods: - <code>forward(input: Tensor, target: Tensor) -&gt; Tensor</code>: Calculates the cross-entropy loss between the input (logits) and the target (class indices).</p>
<p>Example:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    Linear(<span class="dv">10</span>, <span class="dv">20</span>),</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    ReLU(),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    Linear(<span class="dv">20</span>, <span class="dv">10</span>),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> CrossEntropyLoss()</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>output <span class="op">=</span> model(input_tensor)  <span class="co"># compute model output</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> loss_fn(output, target_tensor)  <span class="co"># compute loss</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<p><a href="https://github.com/m0saan/minima/blob/main/minima/nn.py#L446" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="softmax" class="level3">
<h3 class="anchored" data-anchor-id="softmax">Softmax</h3>
<blockquote class="blockquote">
<pre><code> Softmax ()</code></pre>
</blockquote>
<p>Cross-entropy loss module in Minima.</p>
<p>This module computes the Cross Entropy Loss between the input logits and the target classes. It’s useful in classification tasks where the model outputs probabilities for each class.</p>
<p>Methods: - <code>forward(input: Tensor, target: Tensor) -&gt; Tensor</code>: Calculates the cross-entropy loss between the input (logits) and the target (class indices).</p>
<p>Example:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    Linear(<span class="dv">10</span>, <span class="dv">20</span>),</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    ReLU(),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    Linear(<span class="dv">20</span>, <span class="dv">10</span>),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> CrossEntropyLoss()</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>output <span class="op">=</span> model(input_tensor)  <span class="co"># compute model output</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> loss_fn(output, target_tensor)  <span class="co"># compute loss</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>sm <span class="op">=</span> Softmax()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> mi.Tensor([[ <span class="fl">1.25721</span>,   <span class="fl">1.066163</span>],</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>               [ <span class="fl">1.123695</span>, <span class="op">-</span><span class="fl">0.410479</span>],</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>               [ <span class="fl">0.047494</span>, <span class="op">-</span><span class="fl">1.200239</span>],</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>               [ <span class="fl">0.440039</span>,  <span class="fl">0.884834</span>],])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>sm(t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>minima.Tensor(
[[0.547617 0.452383]
 [0.822616 0.177384]
 [0.776907 0.223093]
 [0.390599 0.609401]])</code></pre>
</div>
</div>
</section>
<section id="layer-normalization" class="level2">
<h2 class="anchored" data-anchor-id="layer-normalization">Layer normalization</h2>
<p>Layer normalization <span class="math inline">\(\text{LN}\)</span> normalizes the input <span class="math inline">\(X\)</span> as follows:</p>
<p>When input <span class="math inline">\(X \in \mathbb{R}^{B \times C}\)</span> is a batch of embeddings, where <span class="math inline">\(B\)</span> is the batch size and <span class="math inline">\(C\)</span> is the number of features. <span class="math inline">\(\gamma \in \mathbb{R}^{C}\)</span> and <span class="math inline">\(\beta \in \mathbb{R}^{C}\)</span>. <span class="math display">\[\text{LN}(X) = \gamma
\frac{X - \underset{C}{\mathbb{E}}[X]}{\sqrt{\underset{C}{Var}[X] + \epsilon}}
+ \beta\]</span></p>
<p>When input <span class="math inline">\(X \in \mathbb{R}^{L \times B \times C}\)</span> is a batch of a sequence of embeddings, where <span class="math inline">\(B\)</span> is the batch size, <span class="math inline">\(C\)</span> is the number of channels, <span class="math inline">\(L\)</span> is the length of the sequence. <span class="math inline">\(\gamma \in \mathbb{R}^{C}\)</span> and <span class="math inline">\(\beta \in \mathbb{R}^{C}\)</span>. <span class="math display">\[\text{LN}(X) = \gamma
\frac{X - \underset{C}{\mathbb{E}}[X]}{\sqrt{\underset{C}{Var}[X] + \epsilon}}
+ \beta\]</span></p>
<p>When input <span class="math inline">\(X \in \mathbb{R}^{B \times C \times H \times W}\)</span> is a batch of image representations, where <span class="math inline">\(B\)</span> is the batch size, <span class="math inline">\(C\)</span> is the number of channels, <span class="math inline">\(H\)</span> is the height and <span class="math inline">\(W\)</span> is the width. This is not a widely used scenario. <span class="math inline">\(\gamma \in \mathbb{R}^{C \times H \times W}\)</span> and <span class="math inline">\(\beta \in \mathbb{R}^{C \times H \times W}\)</span>. <span class="math display">\[\text{LN}(X) = \gamma
\frac{X - \underset{C, H, W}{\mathbb{E}}[X]}{\sqrt{\underset{C, H, W}{Var}[X] + \epsilon}}
+ \beta\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> mi.Tensor(init.rand(<span class="dv">5</span>, <span class="dv">10</span>))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>X</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>minima.Tensor(
[[0.424498 0.53646  0.553287 0.97566  0.097845 0.951467 0.582025 0.259501 0.248237 0.651587]
 [0.762057 0.323642 0.67996  0.59344  0.998091 0.910109 0.327038 0.583429 0.118361 0.912831]
 [0.503303 0.953529 0.739612 0.116599 0.830379 0.703346 0.34279  0.722535 0.687944 0.927093]
 [0.874576 0.247239 0.280458 0.342372 0.324733 0.963528 0.838563 0.806436 0.37879  0.214825]
 [0.659279 0.326977 0.308499 0.127876 0.815616 0.123615 0.956371 0.24132  0.681585 0.669349]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>bs, fs <span class="op">=</span> X.shape</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>bs, fs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(5, 10)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>mean <span class="op">=</span> X.<span class="bu">sum</span>(axes<span class="op">=</span>(<span class="dv">1</span>,)) <span class="op">/</span> fs</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>mean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>minima.Tensor(
[0.528057 0.620896 0.652713 0.527152 0.491049])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>mean <span class="op">=</span> mean.reshape((bs, <span class="dv">1</span>))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>mean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>minima.Tensor(
[[0.528057]
 [0.620896]
 [0.652713]
 [0.527152]
 [0.491049]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>mean <span class="op">=</span> mean.broadcast_to(X.shape)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>mean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>minima.Tensor(
[[0.528057 0.528057 0.528057 0.528057 0.528057 0.528057 0.528057 0.528057 0.528057 0.528057]
 [0.620896 0.620896 0.620896 0.620896 0.620896 0.620896 0.620896 0.620896 0.620896 0.620896]
 [0.652713 0.652713 0.652713 0.652713 0.652713 0.652713 0.652713 0.652713 0.652713 0.652713]
 [0.527152 0.527152 0.527152 0.527152 0.527152 0.527152 0.527152 0.527152 0.527152 0.527152]
 [0.491049 0.491049 0.491049 0.491049 0.491049 0.491049 0.491049 0.491049 0.491049 0.491049]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>x_centred <span class="op">=</span> X <span class="op">-</span> mean</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>x_centred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>minima.Tensor(
[[-0.103559  0.008403  0.02523   0.447604 -0.430211  0.42341   0.053968 -0.268556 -0.27982   0.12353 ]
 [ 0.141161 -0.297254  0.059064 -0.027456  0.377195  0.289213 -0.293858 -0.037467 -0.502535  0.291935]
 [-0.14941   0.300816  0.086899 -0.536114  0.177666  0.050634 -0.309923  0.069822  0.035231  0.27438 ]
 [ 0.347424 -0.279913 -0.246694 -0.18478  -0.202419  0.436376  0.311411  0.279284 -0.148362 -0.312327]
 [ 0.16823  -0.164072 -0.18255  -0.363173  0.324568 -0.367433  0.465322 -0.249728  0.190536  0.1783  ]])</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/m0saan/minima/blob/main/minima/nn.py#L487" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="layernorm1d" class="level3">
<h3 class="anchored" data-anchor-id="layernorm1d">LayerNorm1d</h3>
<blockquote class="blockquote">
<pre><code> LayerNorm1d (dim:int, eps=1e-05, device=None, dtype='float32')</code></pre>
</blockquote>
<p>1D Layer normalization module in Minima.</p>
<p>Applies layer normalization over a 1D input. The mean and standard deviation are computed over the last dimension.</p>
<p>Attributes: - <code>dim</code> (int): The dimension of the input feature space. - <code>eps</code> (float): A small constant for numerical stability. - <code>weight</code> (Parameter): The learnable weights of the module of size ‘dim’, initialized with ones. - <code>bias</code> (Parameter): The learnable bias of the module of size ‘dim’, initialized with zeros.</p>
<p>Methods: - <code>forward(x: Tensor) -&gt; Tensor</code>: Applies layer normalization to the input tensor.</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>dim</td>
<td>int</td>
<td></td>
<td>The dimension of the input feature space.</td>
</tr>
<tr class="even">
<td>eps</td>
<td>float</td>
<td>1e-05</td>
<td>A small constant for numerical stability. Default is 1e-5.</td>
</tr>
<tr class="odd">
<td>device</td>
<td>NoneType</td>
<td>None</td>
<td>The desired device of returned tensor. If None, uses the current device for the default tensor type. Default is None.</td>
</tr>
<tr class="even">
<td>dtype</td>
<td>str</td>
<td>float32</td>
<td>The desired data type of returned tensor. If None, uses the default data type. Default is “float32”.</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="batch-norm" class="level2">
<h2 class="anchored" data-anchor-id="batch-norm">Batch Norm</h2>
<p>This is an implementation of Batch Normalization from paper <a href="https://papers.labml.ai/paper/1502.03167">Batch Normalization: Accelerating Deep Network Training by Reducing Internal Covariate Shift</a>.</p>
<section id="internal-covariate-shift" class="level3">
<h3 class="anchored" data-anchor-id="internal-covariate-shift">Internal Covariate Shift</h3>
<p>The paper defines <em>Internal Covariate Shift</em> as the change in the distribution of network activations due to the change in network parameters during training. For example, let’s say there are two layers <span class="math inline">\(l_1\)</span> and <span class="math inline">\(l_2\)</span>. During the beginning of the training <span class="math inline">\(l_1\)</span> outputs (inputs to <span class="math inline">\(l_2\)</span>) could be in distribution <span class="math inline">\(\mathcal{N}(0.5, 1)\)</span>. Then, after some training steps, it could move to <span class="math inline">\(\mathcal{N}(0.6, 1.5)\)</span>. This is <em>internal covariate shift</em>.</p>
<p>Internal covariate shift will adversely affect training speed because the later layers (<span class="math inline">\(l_2\)</span> in the above example) have to adapt to this shifted distribution.</p>
<p>By stabilizing the distribution, batch normalization minimizes the internal covariate shift.</p>
</section>
</section>
<section id="normalization" class="level2">
<h2 class="anchored" data-anchor-id="normalization">Normalization</h2>
<p>It is known that whitening improves training speed and convergence. <em>Whitening</em> is linearly transforming inputs to have zero mean, unit variance, and be uncorrelated.</p>
<section id="normalizing-outside-gradient-computation-doesnt-work" class="level3">
<h3 class="anchored" data-anchor-id="normalizing-outside-gradient-computation-doesnt-work">Normalizing outside gradient computation doesn’t work</h3>
<p>Normalizing outside the gradient computation using pre-computed (detached) means and variances doesn’t work. For instance. (ignoring variance), let <span class="math display">\[\hat{x} = x - \mathbb{E}[x]\]</span> where <span class="math inline">\(x = u + b\)</span> and <span class="math inline">\(b\)</span> is a trained bias and <span class="math inline">\(\mathbb{E}[x]\)</span> is an outside gradient computation (pre-computed constant).</p>
<p>Note that <span class="math inline">\(\hat{x}\)</span> has no effect on <span class="math inline">\(b\)</span>. Therefore, <span class="math inline">\(b\)</span> will increase or decrease based <span class="math inline">\(\frac{\partial{\mathcal{L}}}{\partial x}\)</span>, and keep on growing indefinitely in each training update. The paper notes that similar explosions happen with variances.</p>
</section>
<section id="batch-normalization" class="level3">
<h3 class="anchored" data-anchor-id="batch-normalization">Batch Normalization</h3>
<p>Whitening is computationally expensive because you need to de-correlate and the gradients must flow through the full whitening calculation.</p>
<p>The paper introduces a simplified version which they call <em>Batch Normalization</em>. First simplification is that it normalizes each feature independently to have zero mean and unit variance: <span class="math display">\[\hat{x}^{(k)} = \frac{x^{(k)} - \mathbb{E}[x^{(k)}]}{\sqrt{Var[x^{(k)}]}}\]</span> where <span class="math inline">\(x = (x^{(1)} ... x^{(d)})\)</span> is the <span class="math inline">\(d\)</span>-dimensional input.</p>
<p>The second simplification is to use estimates of mean <span class="math inline">\(\mathbb{E}[x^{(k)}]\)</span> and variance <span class="math inline">\(Var[x^{(k)}]\)</span> from the mini-batch for normalization; instead of calculating the mean and variance across the whole dataset.</p>
<p>Normalizing each feature to zero mean and unit variance could affect what the layer can represent. As an example paper illustrates that, if the inputs to a sigmoid are normalized most of it will be within <span class="math inline">\([-1, 1]\)</span> range where the sigmoid is linear. To overcome this each feature is scaled and shifted by two trained parameters <span class="math inline">\(\gamma^{(k)}\)</span> and <span class="math inline">\(\beta^{(k)}\)</span>. <span class="math display">\[y^{(k)} =\gamma^{(k)} \hat{x}^{(k)} + \beta^{(k)}\]</span> where <span class="math inline">\(y^{(k)}\)</span> is the output of the batch normalization layer.</p>
<p>Note that when applying batch normalization after a linear transform like <span class="math inline">\(Wu + b\)</span> the bias parameter <span class="math inline">\(b\)</span> gets cancelled due to normalization. So you can and should omit bias parameter in linear transforms right before the batch normalization.</p>
<p>Batch normalization also makes the back propagation invariant to the scale of the weights and empirically it improves generalization, so it has regularization effects too.</p>
</section>
</section>
<section id="inference" class="level2">
<h2 class="anchored" data-anchor-id="inference">Inference</h2>
<p>We need to know <span class="math inline">\(\mathbb{E}[x^{(k)}]\)</span> and <span class="math inline">\(Var[x^{(k)}]\)</span> in order to perform the normalization. So during inference, you either need to go through the whole (or part of) dataset and find the mean and variance, or you can use an estimate calculated during training. The usual practice is to calculate an exponential moving average of mean and variance during the training phase and use that for inference.</p>
<p>Batch normalization layer <span class="math inline">\(\text{BN}\)</span> normalizes the input <span class="math inline">\(X\)</span> as follows:</p>
<p>When input <span class="math inline">\(X \in \mathbb{R}^{B \times C \times H \times W}\)</span> is a batch of image representations, where <span class="math inline">\(B\)</span> is the batch size, <span class="math inline">\(C\)</span> is the number of channels, <span class="math inline">\(H\)</span> is the height and <span class="math inline">\(W\)</span> is the width. <span class="math inline">\(\gamma \in \mathbb{R}^{C}\)</span> and <span class="math inline">\(\beta \in \mathbb{R}^{C}\)</span>. <span class="math display">\[\text{BN}(X) = \gamma
\frac{X - \underset{B, H, W}{\mathbb{E}}[X]}{\sqrt{\underset{B, H, W}{Var}[X] + \epsilon}}
+ \beta\]</span></p>
<p>When input <span class="math inline">\(X \in \mathbb{R}^{B \times C}\)</span> is a batch of embeddings, where <span class="math inline">\(B\)</span> is the batch size and <span class="math inline">\(C\)</span> is the number of features. <span class="math inline">\(\gamma \in \mathbb{R}^{C}\)</span> and <span class="math inline">\(\beta \in \mathbb{R}^{C}\)</span>. <span class="math display">\[\text{BN}(X) = \gamma
\frac{X - \underset{B}{\mathbb{E}}[X]}{\sqrt{\underset{B}{Var}[X] + \epsilon}}
+ \beta\]</span></p>
<p>When input <span class="math inline">\(X \in \mathbb{R}^{B \times C \times L}\)</span> is a batch of a sequence embeddings, where <span class="math inline">\(B\)</span> is the batch size, <span class="math inline">\(C\)</span> is the number of features, and <span class="math inline">\(L\)</span> is the length of the sequence. <span class="math inline">\(\gamma \in \mathbb{R}^{C}\)</span> and <span class="math inline">\(\beta \in \mathbb{R}^{C}\)</span>. <span class="math display">\[\text{BN}(X) = \gamma
\frac{X - \underset{B, L}{\mathbb{E}}[X]}{\sqrt{\underset{B, L}{Var}[X] + \epsilon}}
+ \beta\]</span></p>
<hr>
<p><a href="https://github.com/m0saan/minima/blob/main/minima/nn.py#L546" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="batchnorm1d" class="level3">
<h3 class="anchored" data-anchor-id="batchnorm1d">BatchNorm1d</h3>
<blockquote class="blockquote">
<pre><code> BatchNorm1d (dim:int, eps=1e-05, momentum=0.1, device=None,
              dtype='float32')</code></pre>
</blockquote>
<p>1D Batch normalization module in Minima.</p>
<p>This module applies Batch Normalization over a 1D input as described in the paper “Batch Normalization: Accelerating Deep Network Training by Reducing Internal Covariate Shift” by Ioffe and Szegedy.</p>
<p>Attributes: - <code>dim</code> (int): The dimension of the input feature space. - <code>eps</code> (float): A small constant added to the denominator for numerical stability. - <code>momentum</code> (float): The value used for the running_mean and running_var computation. - <code>weight</code> (Parameter): The learnable scale factor of the module of size ‘dim’, initialized with ones. - <code>bias</code> (Parameter): The learnable offset of the module of size ‘dim’, initialized with zeros. - <code>running_mean</code> (Tensor): The running mean. Represents the mean of the features over batches. Initialized with zeros. - <code>running_std</code> (Tensor): The running standard deviation. Represents the standard deviation of the features over batches. Initialized with ones.</p>
<p>Methods: - <code>update_stats(x: Tensor) -&gt; Tuple[Tensor, Tensor]</code>: Calculates the mean and standard deviation of the input tensor. - <code>forward(x: Tensor) -&gt; Tensor</code>: Applies batch normalization to the input tensor.</p>
<p>Example:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>batch_norm <span class="op">=</span> BatchNorm1d(dim<span class="op">=</span><span class="dv">512</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>output <span class="op">=</span> batch_norm(input_tensor)  <span class="co"># Apply batch normalization</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>/opt/hostedtoolcache/Python/3.9.17/x64/lib/python3.9/site-packages/fastcore/docscrape.py:225: UserWarning: potentially wrong underline length... 
Parameters: 
---------- in 
Dropout Layer for a Neural Network.
...
  else: warn(msg)</code></pre>
<hr>
<p><a href="https://github.com/m0saan/minima/blob/main/minima/nn.py#L651" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="dropout" class="level3">
<h3 class="anchored" data-anchor-id="dropout">Dropout</h3>
<blockquote class="blockquote">
<pre><code> Dropout (p=0.5)</code></pre>
</blockquote>
<p>Dropout Layer for a Neural Network.</p>
<p>This class represents a dropout layer in a neural network, which is a simple and effective regularization technique. During training, it randomly zeroes out some of the elements of the input tensor with probability p using samples from a Bernoulli distribution.</p>
</section>
</section>
<section id="parameters" class="level2">
<h2 class="anchored" data-anchor-id="parameters">Parameters:</h2>
<p>p: float, optional, default = 0.5 Probability of an element to be zeroed. Default: 0.5.</p>
<pre><code>/opt/hostedtoolcache/Python/3.9.17/x64/lib/python3.9/site-packages/fastcore/docscrape.py:225: UserWarning: potentially wrong underline length... 
Parameters: 
---------- in 
Residual Layer for a Neural Network.
...
  else: warn(msg)</code></pre>
<hr>
<p><a href="https://github.com/m0saan/minima/blob/main/minima/nn.py#L704" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="residual" class="level3">
<h3 class="anchored" data-anchor-id="residual">Residual</h3>
<blockquote class="blockquote">
<pre><code> Residual (fn:__main__.Module)</code></pre>
</blockquote>
<p>Residual Layer for a Neural Network.</p>
<p>This class represents a residual layer in a neural network, which is a technique that helps to overcome the problem of vanishing and exploding gradients in deep neural networks. It achieves this by allowing gradients to pass through layers directly (via an identity shortcut connection) without any modification.</p>
</section>
</section>
<section id="parameters-1" class="level2">
<h2 class="anchored" data-anchor-id="parameters-1">Parameters:</h2>
<p>fn: Module The function to be applied to the input tensor.</p>
<hr>
<p><a href="https://github.com/m0saan/minima/blob/main/minima/nn.py#L749" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="identity" class="level3">
<h3 class="anchored" data-anchor-id="identity">Identity</h3>
<blockquote class="blockquote">
<pre><code> Identity ()</code></pre>
</blockquote>
<p>Base class for all neural network modules in Minima.</p>
<p>Your models should also subclass this class. Subclasses should define a <code>forward</code> method.</p>
<p>Attributes: - <code>training</code> (bool): Module is initialized in training mode by default. Use <code>eval()</code> to switch it to evaluation mode.</p>
<p>Methods: - <code>parameters()</code>: Returns a list of all <a href="https://m0saan.github.io/minima/nn.html#parameter"><code>Parameter</code></a> instances in the module. - <code>_children()</code>: Returns a list of all child <a href="https://m0saan.github.io/minima/nn.html#module"><code>Module</code></a> instances. - <code>eval()</code>: Switches the module and all its children to evaluation mode. - <code>train()</code>: Switches the module and all its children back to training mode. - <code>__call__()</code>: The call method, which simply calls the <code>forward</code> method, must be defined by all subclasses.</p>
</section>
</section>
<section id="export" class="level2">
<h2 class="anchored" data-anchor-id="export">Export</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> nbdev<span class="op">;</span> nbdev.nbdev_export()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>